<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http
://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.2.xsd">
	<header>
		<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>

		<title lang="en">MSSTI RSS Feed 2.0 with ACP</title>

		<description lang="en">This MOD adds a Really Simple Syndication (RSS) content to your forum.
		Can display list of Forums, Topics, Post, user post ( like ego search ) a particular forum or particular topic.
		Also it have pagination to have a fast view and better performance.</description>

		<author-notes lang="en"><![CDATA[
	RSS Feed Parser in Conjunction with Feeds Everywhere
	W3C Feed Validation Service

	Feature list :
		* ACP component for easy configuration
		* RSS for the entire board.
		* RSS for all forum.
		* RSS for all topics.
		* RSS for all post.
		* RSS for Single Forum and/or Topics.
		* RSS for News topics.
		* RSS for New posts.
		* RSS for Attahments.
		* Adjustable length of messages to display.
		* Adjustable size of feeds.
		* Option to display Attachments.
		* Hides private forums.
		* Excluded forums.
		And more...

	-------------------------------------------------------------------

	Please do not remove the copyright notices without my permission.

	-------------------------------------------------------------------
	This MOD works in pbpBB 3.0.5 and 	AutoMOD 

	Tested on Windows Browsers:
		- Internet Explorer 7.0
		- Mozilla Firefox 2.0
		- Mozilla Firefox 3.0
		- Chrome with RamIsp applet
		- Opera 9.5
		- Safari 3.0
		- Netscape 9

	-------------------------------------------------------------------

	Translation : ( See contrib/language folder )
		en [English]
		es_ar [Spanish (Argentina)]

	-------------------------------------------------------------------

	Need extra support ?
	--------------------
	You can contact me at http://www.mssti.com/phpbb3/]]></author-notes>

		<author-group>
			<author>
				<realname>Gabriel</realname>
				<username>leviatan21</username>
				<email>info@mssti.com</email>
				<homepage>http://www.mssti.com/phpbb3/</homepage>
				<contributions-group>
					<contributions status="current" from="2008-08-27" position="Developer"/>
	      		</contributions-group>			 				
			</author>
		</author-group>

		<mod-version>1.2.1-PL1</mod-version>

		<installation>
			<level>easy</level>
			<time>600</time>
			<target-version>3.0.5</target-version>
		</installation>

		<history>
			<entry>
				<date>2009-06-01</date>
				<rev-version>1.2.1</rev-version>
				<changelog lang="en">
					<change> [Change] Style for attach, Code and Quote</change>
					<change> [Feature] Property display available feeds.</change>
					<change> [Feature] Added integrated icon add-on</change>
					<change> [Fix] Bug with special characters</change>
					<change> [Fix] Issues reported by MOD Team</change>
					<change> [Fix] Permissions : Exclude passworded forum completely</change>
					<change> [Fix] Parse and display post content</change>
				</changelog>
			</entry>

			<entry>
				<date>2009-04-10</date>
				<rev-version>1.2.0</rev-version>
				<changelog lang="en">
					<change> [Change] Re-writed and optimized code ( Thanks to ...I can't tell who... you know who you are... )</change>
					<change> [Feature] Added new posts feeds : will display latest post since your last visit to the board.</change>
					<change> [Feature] Added attachment feeds : will display attach files only</change>
					<change> [Feature] More ACP settings for customization.</change>
				</changelog>
			</entry>

			<entry>
				<date>2009-02-20</date>
				<rev-version>1.0.9</rev-version>
				<changelog lang="en">
					<change> [Fix] Exclude forums</change>
					<change> [Feature] Do not pull up the feed info, if the feed option is set to Disabled</change>
					<change> [Feature] Remove user-emails from feed if the user hide his e-mail address, optionality use the board email</change>
					<change> [Feature] Display attachment</change>
					<change> [Feature] Added Debug mode</change>
					<change> [Feature] Use HTTP Apache authentication if needed</change>
					<change> [Change] All sql query using sql_build_query() for optimisation </change>
				</changelog>
			</entry>

			<entry>
				<date>2009-01-22</date>
				<rev-version>1.0.8</rev-version>
				<changelog lang="en">
					<change> [Fix] Links </change>
					<change> [Fix] Bug with special characters</change>
					<change> [Fix] Board statistics</change>
					<change> [Feature] Added News feeds : pull data from specific forum or forums</change>
					<change> [Feature] Added Exclude forums : The RSS will not pull data from specific forum or forums</change>
					<change> [Change] all sql query using sql_build_query() for optimisation </change>
				</changelog>
			</entry>

			<entry>
				<date>2009-01-14</date>
				<rev-version>1.0.7</rev-version>
				<changelog lang="en">
					<change> [Fix] en language ( thanks to billsaysthis )</change>
					<change> [Fix] Author name and link</change>
					<change> [Feature] Display list of topics in forum mode</change>
					<change> [Feature] Display first post in topics mode</change>
					<change> [Feature] Skip permissions</change>
				</changelog>
			</entry>

			<entry>
			<date>2009-01-10</date>
				<rev-version>1.0.6</rev-version>
				<changelog lang="en">
					<change> [Fix] Date/time in RFC2822 format</change>
					<change> [Fix] disabled sid in links, to avoid duplicated items</change>
					<change> [Feature] Enhaced RSS ACP, now is more customizable</change>
					<change> [Feature] Added image resize</change>
				</changelog>
			</entry>

			<entry>
				<date>2009-01-03</date>
				<rev-version>1.0.5</rev-version>
				<changelog lang="en">
					<change> [Fix] Date/time in RFC2822 format</change>
					<change> [Fix] Parse and display post content</change>
					<change> [Fix] Author links ( in every posible place )</change>
					<change> [Fix] Main sql query</change>
					<change> [Fix] Skip Paswored forums</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-08-25</date>
				<rev-version>1.0.4</rev-version>
				<changelog lang="en">
					<change> [Fix] Severals issues reported by MOD Team</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-07-23</date>
				<rev-version>1.0.3</rev-version>
				<changelog lang="en">
					<change> [Fix] Pagination problems</change>
					<change> [Feature] Display forum stats only in the first page</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-01-30</date>
				<rev-version>1.0.2</rev-version>
				<changelog lang="en">
					<change> [Fix] Some IE problems</change>
					<change> [Fix] Display post content if is allowed</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-01-10</date>
				<rev-version>1.0.1</rev-version>
				<changelog lang="en">
					<change>First release to phpbb 3.0.1 Gold</change>
				</changelog>
			</entry>
		</history>

		<link-group>
			<link type="template" href="contrib/subsilver2.xml" lang="en">Subsilver2</link>
			<link type="contrib" href="contrib/RSSFeed20_icon.xml" lang="en">This file provides instructions for display a RSS icon next each forums and topics.</link>
			<link type="contrib" href="contrib/update/update_120_to_121.xml" lang="en">This file provides instructions for upgrading the MOD from version 1.2.0 to 1.2.1</link>
		</link-group>

	</header>

	<action-group>
		<copy>
			<file from="root/rss.php" to="rss.php" />
			<file from="root/includes/acp/acp_rss.php" to="includes/acp/acp_rss.php" />
			<file from="root/includes/acp/info/acp_rss.php" to="includes/acp/info/acp_rss.php" />
			<file from="root/language/en/mods/rss.php" to="language/en/mods/rss.php" />
			<file from="root/styles/rss_template.xml" to="styles/rss_template.xml" />
		</copy>

		<open src="includes/functions.php">
			<edit>
				<find><![CDATA[	// The following assigns all _common_ variables that may be used at any point in a template.]]></find>
				<action type="before-add"><![CDATA[

// MOD : MSSTI RSS Feeds (V1.2.1) - Start
	// Safety check
	if ( $config['rss_enable'] = ( isset($config['rss_enable']) ? $config['rss_enable'] : false) )
	{
		$u_rss = generate_board_url() . "/rss.$phpEx";
		$f_rss = request_var('f', 0);
		$t_rss = request_var('t', 0);
		$rss_excluded_forums_ary = rss_filters();
	}
// MOD : MSSTI RSS Feeds (V1.2.1) - End

]]></action>
			</edit>

			<edit>
				<find><![CDATA[		'SITE_LOGO_IMG'			=> $user->img('site_logo')]]></find>
				<action type="before-add"><![CDATA[

// MOD : MSSTI RSS Feeds (V1.2.1) - Start
		'S_FEEDS'				=> ( $config['rss_enable'] ) ? true : false,
		'U_RSS'					=> ( $config['rss_enable'] ) ? $u_rss : '',
		'U_FEEDS_NEWS'			=> ( $config['rss_enable'] && $config['rss_news_id'] != '' ) ? $u_rss . '?mode=news' : '',
		'U_FEEDS_NEWPOST'		=> ( $config['rss_enable'] && $config['rss_newposts'] != '' ) ? $u_rss . '?mode=newposts' : '',
		'U_FEEDS_FORUMS'		=> ( $config['rss_enable'] && $config['rss_overall_forums'] ) ? $u_rss . '?mode=forums' : '',
		'U_FEEDS_THREADS'		=> ( $config['rss_enable'] && $config['rss_overall_threads'] ) ? $u_rss . '?mode=topics' : '',
		'U_FEEDS_POSTS'			=> ( $config['rss_enable'] && $config['rss_overall_posts'] ) ? $u_rss . '?mode=posts' : '',
		'U_FEEDS_ATTACH'		=> ( $config['rss_enable'] && $config['rss_attach'] )? $u_rss . '?mode=attachments' : '',
		'U_FEEDS_EGOSEARCH' 	=> ( $config['rss_enable'] && $config['rss_egosearch'] && $user->data['user_id'] != ANONYMOUS ) ? $u_rss . '?mode=egosearch&amp;uid=' . $user->data['user_id'] : '',
		'U_FEEDS_FORUM'			=> ( $config['rss_enable'] && $config['rss_forum'] && $f_rss && !in_array( $f_rss, $rss_excluded_forums_ary )) ? $u_rss . '?f=' . $f_rss : '',
		'U_FEEDS_THREAD'		=> ( $config['rss_enable'] && $config['rss_thread'] && $t_rss && !in_array( $f_rss, $rss_excluded_forums_ary )) ? $u_rss . '?f=' . $f_rss . '&amp;t=' . $t_rss : '',
// MOD : MSSTI RSS Feeds (V1.2.1) - End

]]></action>
			</edit>

			<edit>
				<find><![CDATA[?>]]></find>
				<action type="before-add"><![CDATA[

// MOD : MSSTI RSS Feeds (V1.2.1) - Start
/**
* Find out in which forums ( and all it's child's ) the user is not allowed to view
* 
* @return array 	$rss_excluded_forums_ary with forum id to exclude
**/
function rss_filters()
{
	global $auth, $db, $config, $phpbb_root_path, $phpEx, $rss_excluded_forums_ary;

	// Do not run twice if it has already been executed earlier.
	if ( isset($rss_excluded_forums_ary) && is_array($rss_excluded_forums_ary) )
	{
		return $rss_excluded_forums_ary;
	}

	$rss_excluded_forums_ary = array();

	// Which forums should be directly excluded ?
	if ( $config['rss_exclude_id'] != '' )
	{
		if (!is_array( $config['rss_exclude_id'] ))
		{
			$forums_id	= explode(",", $config['rss_exclude_id'] );
		}
		foreach ( $forums_id as $fid )
		{
			if ( $fid )
			{
				$rss_excluded_forums_ary[] = (int) $fid;
			}
		}
	}

	// Start with a list of forums without initial exclusions id's
	$not_in_fid = ( sizeof($rss_excluded_forums_ary) ) ? 'WHERE (' . $db->sql_in_set('forum_id', $rss_excluded_forums_ary, true) . ") OR (forum_password <> '' )" : '';

	$sql = "SELECT forum_id, parent_id, forum_password, forum_parents, left_id, right_id 
			FROM " . FORUMS_TABLE . "  
			$not_in_fid
			ORDER BY forum_id";
	$rss_filters_result = $db->sql_query($sql);

	while ( $forum_data = $db->sql_fetchrow($rss_filters_result) )
	{
		// Exclude passworded forum completely ( for some reason the (forum_password <> '' ) in SQL query doesn't work ;) )
		if ( $forum_data['forum_password'] != '' )
		{
			$rss_excluded_forums_ary[] = (int) $forum_data['forum_id'];
			continue;
		}

		// Exclude forums the user is not able to read
		if ( !$auth->acl_get('f_list', $forum_data['forum_id']) )
		{
			$rss_excluded_forums_ary[] = (int) $forum_data['forum_id'];
			continue;
		}

		// Skip direct child of a excluded forum
		if ( in_array($forum_data['parent_id'], $rss_excluded_forums_ary) )
		{
			$rss_excluded_forums_ary[] = (int) $forum_data['forum_id'];
			continue;
		}

		if ( $forum_data['parent_id'] > 0 )
		{
			// Needed for some pages, like login ;)
			require_once( $phpbb_root_path . 'includes/functions_display.' . $phpEx );

			// Get forum parents
			$forum_parents = get_forum_parents( $forum_data );

			// Search for subforums
			if ( !empty( $forum_parents ) )
			{
				foreach ( $forum_parents as $parent_forum_id => $parent_data )
				{
					// Skip this parent if the user does not have the permission to view it
					if ( !$auth->acl_get('f_list', $parent_forum_id) )
					{
						$rss_excluded_forums_ary[] = $parent_forum_id;
						continue;
					}

					// Skip this forum if it's the child of a excluded forum
					if ( in_array($parent_forum_id, $rss_excluded_forums_ary) )
					{
						$rss_excluded_forums_ary[] = (int) $forum_data['forum_id'];
						continue;
					}
				}
			}
		}
	}
	$db->sql_freeresult($rss_filters_result);

	return $rss_excluded_forums_ary;
}
// MOD : MSSTI RSS Feeds (V1.2.1) - End
]]></action>
			</edit>
		</open>

		<open src="language/en/common.php">
			<edit>
				<find><![CDATA[	'default_dateformat'	=> 'D M d, Y g:i a', // Mon Jan 01, 2007 1:37 pm]]></find>
				<action type="after-add"><![CDATA[

// MOD : MSSTI RSS Feeds (V1.2.1) - Start
	'YOUR_POSTS'			=> 'Your posts',
	'RSS_FEEDS'				=> 'RSS Feeds',
	'RSS_NEWS'				=> 'News',
	'RSS_NEWPOST'			=> 'New posts',
	'RSS_ATTACH'			=> 'Attachments',
// MOD : MSSTI RSS Feeds (V1.2.1) - End

]]></action>
			</edit>
		</open>

		<open src="language/en/acp/common.php">
			<edit>
				<find><![CDATA[	'LOG_WORD_EDIT'			=> '<strong>Edited word censor</strong><br />» %s',]]></find>
				<action type="after-add"><![CDATA[

// MOD : MSSTI RSS Feeds (V1.2.1) - Start
	'ACP_RSS'					=> 'RSS management',
	'ACP_RSS_FEEDS'				=> 'RSS',
	'LOG_CONFIG_RSS_FEEDS'		=> '<strong>Configured RSS feeds</strong>',
// MOD : MSSTI RSS Feeds (V1.2.1) - End

]]></action>
				<comment lang="en">NOTE: See contrib/language folder for availables transtations</comment>
			</edit>
		</open>

		<open src="styles/prosilver/template/overall_header.html">
			<edit>
				<find><![CDATA[<title>{SITENAME} &bull; <!-- IF S_IN_MCP -->{L_MCP} &bull; <!-- ELSEIF S_IN_UCP -->{L_UCP} &bull; <!-- ENDIF -->{PAGE_TITLE}</title>]]></find>
				<action type="after-add"><![CDATA[

<!-- MOD : MSSTI RSS Feeds (V1.2.1) - Start //-->
<!-- IF S_FEEDS -->
<link rel="alternate" type="application/rss+xml" title="{L_RSS_FEEDS} - {SITENAME}" href="{U_RSS}" />
<!-- IF U_FEEDS_NEWS --><link rel="alternate" type="application/rss+xml" title="{L_RSS_FEEDS} - {L_RSS_NEWS}" href="{U_FEEDS_NEWS}" /><!-- ENDIF -->
<!-- IF U_FEEDS_NEWPOST --><link rel="alternate" type="application/rss+xml" title="{L_RSS_FEEDS} - {L_RSS_NEWPOST}" href="{U_FEEDS_NEWPOST}" /><!-- ENDIF -->
<!-- IF U_FEEDS_FORUMS --><link rel="alternate" type="application/rss+xml" title="{L_RSS_FEEDS} - {L_ALL_FORUMS}" href="{U_FEEDS_FORUMS}" /><!-- ENDIF -->
<!-- IF U_FEEDS_THREADS --><link rel="alternate" type="application/rss+xml" title="{L_RSS_FEEDS} - {L_ALL_TOPICS}" href="{U_FEEDS_THREADS}" /><!-- ENDIF -->
<!-- IF U_FEEDS_POSTS --><link rel="alternate" type="application/rss+xml" title="{L_RSS_FEEDS} - {L_ALL_POSTS}" href="{U_FEEDS_POSTS}" /><!-- ENDIF -->
<!-- IF U_FEEDS_ATTACH --><link rel="alternate" type="application/rss+xml" title="{L_RSS_FEEDS} - {L_RSS_ATTACH}" href="{U_FEEDS_ATTACH}" /><!-- ENDIF -->
<!-- IF U_FEEDS_EGOSEARCH --><link rel="alternate" type="application/rss+xml" title="{L_RSS_FEEDS} - {L_YOUR_POSTS}" href="{U_FEEDS_EGOSEARCH}" /><!-- ENDIF -->
<!-- IF U_FEEDS_FORUM --><link rel="alternate" type="application/rss+xml" title="{L_RSS_FEEDS} - {L_FORUM} {FORUM_NAME}" href="{U_FEEDS_FORUM}" /><!-- ENDIF -->
<!-- IF U_FEEDS_THREAD --><link rel="alternate" type="application/rss+xml" title="{L_RSS_FEEDS} - {L_TOPIC} {TOPIC_TITLE}" href="{U_FEEDS_THREAD}" /><!-- ENDIF -->
<!-- ENDIF -->
<!-- MOD : MSSTI RSS Feeds (V1.2.1) - End //-->

]]></action>
				<comment lang="en">NOTE: You will have to make this change to ALL themes based of prosilver you have installed. I use "prosilver" as an example.</comment>
			</edit>
		</open>

		<diy-instructions lang="en"><![CDATA[IMPORTANT ! Once you modify and upload all the files :

Log on to Administration Control Panel
#####################################################################
A) Purge the cache :

	A.1) Navigate to "GENERAL" Tab.
	A.2) Next to "Purge the cache" click on "Run now".
	A.3) in the next screen, click on "Yes".

#####################################################################
B) Purge the templates :

	B.1) Navigate to "STYLES" Tab.
	B.2) Under "Style components " click on "Templates".
	B.3) Under "Actions" click on "Refresh".
	B.4) in the next screen, click on "Yes" ( Repeat last 2 steps to each instaled style, based off prosilver ).

#####################################################################
C) Add RSS Feed module :

	C.1) Navigate to "SYSTEM" tab.
	C.2) Under "Module management" click on "Administration Control Panel".
	C.3) Click on "System".
	C.4) Clik on "General tasks".
	C.5) in "add module" select "RSS" and click on "add module", them click on "yes".
	C.6) Afert refresh screen click RSS "enable".
	C.7) Now you will able to see "RSS" down the "General tasks" in left menu.

#####################################################################
D) RSS Settings

	D.1) Navigate to "SYSTEM" Tab. ( This is the default location for the feed module )
	D.2) Al left menu click on "RSS".
	D.3) Adjust the feed value that best suits your needs.
	D.4) Submit, even if you don't change anything, this will update your database to fit the new version.

#####################################################################
E) Enjoy it !.

		]]></diy-instructions>
	</action-group>

</mod>